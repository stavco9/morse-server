#!/usr/bin/groovy
pipeline {
    agent {
        kubernetes{
            label 'jenkins-docker-slave'
            defaultContainer 'jenkins-docker-slave'
        }
    }    

    environment {
        registryAddress = 'stavco9'
        registryCredential = '964f61be-7736-4d8f-af4a-8951fccf1fd9'
        dockerImage = ''
    }

	stages {
		stage('Build Docker image and push to registry') {
			steps {
                script{
                    // Check pipelineeeeeeeeeee
                    def imageName = "morse-server"
                    def imageTag = "dev-${BUILD_NUMBER}"
                    def listenPort = 5000

                    if(env.BRANCH_NAME == "master" || env.BRANCH_NAME == "release" || env.BRANCH_NAME == "main"){
                        imageTag = "release-${BUILD_NUMBER}"
                        listenPort = 4000
                    }

                    
                    buildImage(imageName, imageTag, listenPort)
                    pushImage()
                }
			}
		}

        stage ('Invoke Test Pipeline') {
            steps {
                build job: 'Morse Server e2e testing', parameters: [
                string(name: 'listenPort', value: listenPort),
                string(name: 'imageName', value: imageName),
                string(name: 'imageTag', value: imageTag)
                ]
            }
        }
	}
}

def buildImage(imageName, imageTag, listenPort){
    dir ('server' ) {
        dockerImage = docker.build("${registryAddress}/${imageName}:${imageTag}", "--build-arg LISTEN_PORT=${listenPort} .")
    }
}

def pushImage(){
    docker.withRegistry( '', registryCredential ) {
        dockerImage.push() 
    }
}