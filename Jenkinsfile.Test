#!/usr/bin/groovy
pipeline {
    agent any

    //options {
    //    skipDefaultCheckout true
    //}

    parameters {
        string(defaultValue: "1095", name: 'listenPort')
        string(defaultValue: "stavco9/fake:manual", name: 'imagePath')
    }

    environment {
        registryAddress = 'stavco9'
        registryCredential = '964f61be-7736-4d8f-af4a-8951fccf1fd9'
        clientImageName = 'morse-client'
        dockerImage = ''
        dnsName = ''
    }

    stages {
        stage('Stop all running server containers'){
            steps{
                echo "${env.BUILD_CASE}"

                echo 'Stopping the server containers'

                stopServerContainerByPort(listenPort)
            }
        }

        stage('Pull Server Image and run it') {
            steps {
                script{
                    pullServerImage(imagePath)
                    runServerImage(imagePath, listenPort)
                }
            }
        }

        stage('Build Client Image'){
            steps{
                buildClientImage(clientImageName)
            }
        }

        stage('Test E2E Server functionality'){
            steps{
                script{
                    serverReachable = false

                    // Get the host IP address
                    serverAddress = sh (
                        script: "/sbin/ip route|awk '/docker0/ { print ${'$'}9 }'",
                        //script: "/sbin/ip route|awk '/default/ { print ${'$'}3 }' | xargs | head -n 1",
                        returnStdout: true).trim()

                    counter = 1

                    // Run the client code                        
                    testPassed = testServer(clientImageName, "http://${serverAddress}:${listenPort}")

                    if (!(testPassed)){
                        error('e2e tests have been failed...')
                    }
                    else{
                        echo 'e2e tests have been passed successfully !!!'
                    }
                }
            }
        }
    }    
    post {
        always {
            echo 'Stopping the server containers'

            stopServerContainerByPort(listenPort)
        }
    }
}

def pullServerImage(imagePath){
    dockerImage = docker.image("${imagePath}")

    docker.withRegistry( '', registryCredential ) {
        dockerImage.pull()
    }
}

def runServerImage(imagePath, listenPort){
    sh "docker run -d -p ${listenPort}:${listenPort} ${imagePath}"
}

def stopServerContainerByPort(listenPort){
    serversContainers = sh (
    script: "docker ps -q --filter publish=${listenPort}",
    returnStdout: true)

    if (serversContainers){
        sh "docker stop ${'$'}(echo ${serversContainers})"

        echo "Stopped"
    }
    else{
        echo "No containers exist"
    }
}

def buildClientImage(imageName){
    dir ('client'){
        dockerImage = docker.build("${imageName}")
    }
}

def testServer(clientImage, serverUrl){
    try{
        sh "docker run -e \"SERVER_URL=${serverUrl}\" ${clientImage}"

        return true
    }
    catch(exc){
        return false
    }
}